version: "3.8"

services:
    postgres:
        image: postgres:16
        container_name: pg_test
        restart: always
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: nc_news_test
            TZ: UTC
        command: ["postgres", "-c", "timezone=UTC"]
        volumes:
            - pgdata:/var/lib/postgresql/data

    node-app:
        build: .
        container_name: test_runner
        depends_on:
            - postgres
        environment:
            PGHOST: postgres
            PGDATABASE: nc_news_test
            PGUSER: postgres
            PGPASSWORD: postgres
            PGPORT: 5432
            NODE_ENV: test
            TZ: UTC
        command: >
            bash -c "./scripts/wait-for-it.sh postgres:5432 --timeout=30 --strict -- node scripts/reset-test-db.js && npm test"

volumes:
    pgdata:
