trigger:
    branches:
        include:
            - main

pool:
    vmImage: "ubuntu-latest"

variables:
    - group: news-app-prod
    - group: render-auth
    - name: NODE_VERSION
      value: "20"

stages:
    - stage: Deploy
      displayName: "Deploy to Production"
      dependsOn: Build
      condition: succeeded()
      jobs:
          - job: DeployProd
            displayName: "Deploy to Render Production"
            steps:
                - checkout: self
                - script: |
                      set -eo pipefail
                      echo "Deploying production branch: $BUILD_SOURCEBRANCHNAME"

                      curl -X POST \
                        -H "Authorization: Bearer $(RENDER_API_KEY)" \
                        -H "Content-Type: application/json" \
                        https://api.render.com/v1/services/$(RENDER_SERVICE_ID)/deploys
                  displayName: "Deploy via Render API"
